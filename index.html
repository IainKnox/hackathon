<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    canvas {
      display: block;
      margin-top: 10vh;
      height: 80vh;
      transition: 2s;
    }
  </style>
</head>

<body>
  <script src="https://kaboomjs.com/lib/0.6.0/kaboom.js"></script>
  <script type="module">

    // init context
    const k = kaboom({
      global: true, // import all kaboom functions to global namespace
      scale: 2, // pixel size (for pixelated games you might want smaller size with scale)
      clearColor: [1, 0, 1, 1], // background color (default is a checker board background)
      fullscreen: false, // if fullscreen
      crisp: true, // if pixel crisp (for sharp pixelated games)
      debug: true, // debug mode
    });

    const gameCanvas = document.getElementsByTagName('canvas')[0]

    // define SFX
    loadSound("gameover_sound", "assets/sounds/annoying_game_over_biploop.wav")
    loadSound("comedy_jump", "assets/sounds/comedy_jump_bip_2loop.wav")
    loadSound("counting", "assets/sounds/counting_bliploop.wav")
    loadSound("death_scream", "assets/sounds/death_scream_biploop.wav")
    loadSound("jump", "assets/sounds/jump_biploop.wav")
    loadSound("jumpy", "assets/sounds/jumpy_biploop.wav")
    loadSound("negative_hit1", "assets/sounds/negative_hit_bip_1loop.wav")
    loadSound("negative_hit2", "assets/sounds/negative_hit_biploop.wav")

    // define 'lionel' sprite
    loadSprite("lionel", "assets/sprites/lionel.png");

    // define map sprites (Mario)
    loadSprite("block", "assets/sprites/block.png")
    loadSprite("brick", "assets/sprites/brick.png")
    loadSprite("coin", "assets/sprites/coin.png")
    loadSprite("question", "assets/sprites/question.png")
    loadSprite("unboxed", "assets/sprites/unboxed.png")
    loadSprite("pipe-left", "assets/sprites/pipe-left.png")
    loadSprite("pipe-right", "assets/sprites/pipe-right.png")
    loadSprite("pipe-top-left-side", "assets/sprites/pipe-top-left-side.png")
    loadSprite("pipe-top-right-side", "assets/sprites/pipe-top-right-side.png")
    loadSprite("evil-shroom-1", "assets/sprites/evil-shroom-1.png")
    loadSprite("mushroom", "assets/sprites/mushroom.png")

    scene("game", () => {

      const MOVE_SPEED = 120
      const JUMP_FORCE = 360
      const BIG_JUMP_FORCE = 550
      let CURRENT_JUMP_FORCE = JUMP_FORCE
      const ENEMY_SPEED = 20
      const FALL_DEATH = 600

      let isJumping = true

      layers(['obj', 'ui'], 'obj')

      // define map (can make a longer array of these later)
      map = [
        '                                                       ',
        '                                                       ',
        '                                                       ',
        '                                                       ',
        '                                                       ',
        '    %   =*=%=                               -+         ',
        '                                            ()         ',
        '                      -+          -+       xxx      -+ ',
        '             ^   ^    ()          ()                () ',
        'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  xxxxxxxx  xxxxxxxx',
      ]

      // define map level config - can make several of these for each level design
      const levelCfg = {
        width: 20,
        height: 20,
        '=': [sprite('block'), solid()],
        'x': [sprite('brick'), solid()],
        '$': [sprite('coin'), 'coin'],
        '%': [sprite('question'), 'coin-surprise', solid()],
        '*': [sprite('question'), 'mushroom-surprise', solid()],
        '}': [sprite('unboxed'), solid()],
        '(': [sprite('pipe-left'), scale(0.5), solid()],
        ')': [sprite('pipe-right'), scale(0.5), solid()],
        '-': [sprite('pipe-top-left-side'), scale(0.5), solid()],
        '+': [sprite('pipe-top-right-side'), scale(0.5), solid(), 'pipe'],
        'r': [sprite('pipe-top-right-side'), scale(0.5), solid()],
        '^': [sprite('evil-shroom-1'), solid(), 'dangerous'],
        '#': [sprite('mushroom'), 'mushroom', body()],
      }

      // creates game level
      const gameLevel = addLevel(map, levelCfg)

      // function that checks if a player is 'big' or not
      function big() {
        // default timer and big status
        let timer = 0
        let isBig = false
        return {
          update() {
            if (isBig) {
              timer -= dt()
              if (timer <= 0) {
                this.smallify()
              }
            }
          },
          isBig() {
            return isBig
          },
          // makes lionel small once the timer has elapsed
          smallify() {
            play("jump")
            this.scale = vec2(1)
            timer = 0
            isBig = false
            CURRENT_JUMP_FORCE = JUMP_FORCE
          },
          // makes lionel big when eating 'mushroom'
          biggify(time) {
            play("comedy_jump")
            this.scale = vec2(2)
            timer = time
            isBig = true
            CURRENT_JUMP_FORCE = BIG_JUMP_FORCE
          }
        }
      }

      // add lionel sprite
      const lionel = add([
        sprite("lionel"),
        pos(30, 0),
        body(),
        big(),
        origin('bot'),
      ]);

      // defines lionel sprites behaviour - is tracked by camera and falldeath action
      lionel.action(() => {
        camPos(lionel.pos)
        if (lionel.pos.y >= FALL_DEATH) {
          console.log("You Lose")
          lionel.destroy()
          play("death_scream")
          go("gameover")
        }
      });

      // lionel left movement
      keyDown('left', () => {
        lionel.move(-120, 0)
      });

      // lionel right movement
      keyDown('right', () => {
        lionel.move(120, 0)
      });

      // lionel jump (could use spacebar as well maybe?)
      keyPress('up', () => {
        if (lionel.grounded()) {
          isJumping = true
          lionel.jump(CURRENT_JUMP_FORCE)
          play("jumpy")
        }
      });

      // action when lionel collides with 'coin-surprise' sprite
      lionel.collides('coin-surprise', (obj) => {
        play("negative_hit1")
        gameLevel.spawn('$', obj.gridPos.sub(0, 1))
        destroy(obj)
        gameLevel.spawn('}', obj.gridPos.sub(0, 0))
      });

      // action when lionel collides with 'mushroom-surprise' sprite
      lionel.collides('mushroom-surprise', (obj) => {
        play("negative_hit2")
        gameLevel.spawn('#', obj.gridPos.sub(0, 1))
        destroy(obj)
        gameLevel.spawn('}', obj.gridPos.sub(0, 0))
      });

      // action when mushroom is activated
      action('mushroom', (m) => {
        m.move(20, 0)
      });

      // action when lionel collides with mushroom sprite
      lionel.collides('mushroom', (m) => {
        lionel.biggify(6)
        destroy(m)
      });

      // action when lionel collides with coin sprite
      lionel.collides('coin', (c) => {
        play("death_scream")
        destroy(c)
      });

      // sets basic viewing angle
      let angle = 0;
      document.querySelector('canvas').style.setProperty("transform", `rotate(${angle}deg)`)

      // spins game screen when lionel hits a pipe
      lionel.collides('pipe', (p) => {
        console.log(angle)
        angle += 90;
        console.log(angle)
        destroy(p)
        gameLevel.spawn('r', p.gridPos.sub(0, 0))
        play("comedy_jump")
        document.querySelector('canvas').style.setProperty("transform", `rotate(${angle}deg)`)
      });

    });

    // defines gameover screen
    scene("gameover", () => {

      play("gameover_sound")

      // gameover screen text
      add([
        text("Game Over", 16),
        pos(width() / 2, height() / 2),
        origin("center"),
      ]);

      // press space to restart game
      keyPress("space", () => {
        go("start");
      });

    });

    // defines starting screen
    scene("start", () => {

      // starting screen text
      add([
        text("Welcome to Lionoil", 20),
        pos(width() / 2, 120),
        origin("center"),
      ]);

      // starting screen text 2
      add([
        text("Press the space key to begin", 16),
        pos(width() / 2, 180),
        origin("center"),
      ]);

      // press space to start
      keyPress("space", () => {
        go("game");
      });

    })

    // default action on page load - start screen
    go("start")

  </script>
</body>

</html>